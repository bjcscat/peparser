name: tests

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    lint:
        name: Lint & Format Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rokit
              uses: CompeyDev/setup-rokit@v0.1.2

            - name: Install StyLua
              run: |
                  rokit trust luau-lang/luau
                  rokit trust luau-lang/lute
                  rokit trust JohnnyMorganz/StyLua
                  rokit install

            - name: Check formatting
              run: stylua --check src/ tests/ scripts/ examples/

    test:
        name: Run Tests
        runs-on: ubuntu-latest
        needs: lint

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rokit
              uses: CompeyDev/setup-rokit@v0.1.2

            - name: Install Luau and Lute
              run: |
                  rokit trust luau-lang/luau
                  rokit trust luau-lang/lute
                  rokit trust JohnnyMorganz/StyLua
                  rokit install

            - name: Run tests
              run: lute run scripts/run_tests.luau
              shell: bash

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  flags: ${{ matrix.os }}
                  name: codecov-${{ matrix.os }}
                  fail_ci_if_error: false
                  token: ${{ secrets.CODECOV_TOKEN }}
